---
import Layout from '../../layouts/Layout.astro';
import ColorIcons from '../../components/ColorIcons.astro';
import fs from 'node:fs';
import path from 'node:path';

export function getStaticPaths() {
  const dir = path.join(process.cwd(), 'src', 'data', 'commanders');
  const files = fs.readdirSync(dir).filter((f: string) => f.includes('--') && f.endsWith('.json'));
  return files.map((f: string) => ({ params: { pair: f.replace('.json', '') } }));
}

const { pair } = Astro.params;
const dataPath = path.join(process.cwd(), 'src', 'data', 'commanders', `${pair}.json`);
const data = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));
const { commander1, commander2, color_identity, deck_count, top_cards, decks: rawDecks } = data;
const decks = rawDecks?.slice().sort((a: any, b: any) => {
  const da = a.created_at ? new Date(a.created_at).getTime() : 0;
  const db = b.created_at ? new Date(b.created_at).getTime() : 0;
  return db - da;
});

const categories = [
  { key: 'creatures', label: 'Существа' },
  { key: 'instants', label: 'Мгновенные' },
  { key: 'sorceries', label: 'Волшебства' },
  { key: 'artifacts', label: 'Артефакты' },
  { key: 'enchantments', label: 'Чары' },
  { key: 'planeswalkers', label: 'Planeswalkers' },
  { key: 'lands', label: 'Земли' },
];
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
---
<Layout title={`${commander1.name} + ${commander2.name}`}>
  <div class="flex flex-col md:flex-row gap-8 mb-10">
    <div class="flex gap-4 shrink-0">
      {commander1.image_uri && <img src={commander1.image_uri} alt={commander1.name} class="w-40 md:w-56 rounded-xl shadow-2xl" />}
      {commander2.image_uri && <img src={commander2.image_uri} alt={commander2.name} class="w-40 md:w-56 rounded-xl shadow-2xl" />}
    </div>
    <div>
      <h1 class="text-2xl md:text-3xl font-bold text-amber-400 mb-2">
        <a href={`${base}/commanders/${commander1.id}`} class="hover:text-amber-300">{commander1.name}</a>
        <span class="text-gray-500"> + </span>
        <a href={`${base}/commanders/${commander2.id}`} class="hover:text-amber-300">{commander2.name}</a>
      </h1>
      <p class="text-gray-400 mb-4">{data.pair_type === 'background' ? 'Коммандер + Бэкграунд' : 'Партнёры'}</p>
      <div class="flex items-center gap-4 mb-4">
        <ColorIcons colors={color_identity} size="w-6 h-6" />
      </div>
      <div class="bg-gray-900 rounded p-4 inline-block">
        <div class="text-3xl font-bold text-amber-400">{deck_count}</div>
        <div class="text-sm text-gray-400">Деклистов с этой парой</div>
      </div>
    </div>
  </div>

  <!-- Category tabs -->
  <div class="mb-8">
    <div class="flex flex-wrap gap-2 mb-6 border-b border-gray-800 pb-3">
      {categories.map((cat, i) => {
        const cards = (top_cards as any)?.[cat.key];
        if (!cards || cards.length === 0) return null;
        return (
          <button data-tab={cat.key} class={`tab-btn px-4 py-2 rounded-t text-sm font-medium transition ${i === 0 ? 'bg-amber-600 text-white' : 'bg-gray-800 text-gray-400 hover:text-white'}`}>
            {cat.label} ({cards.length})
          </button>
        );
      })}
    </div>
    {categories.map((cat, i) => {
      const cards = (top_cards as any)?.[cat.key];
      if (!cards || cards.length === 0) return null;
      return (
        <div data-panel={cat.key} class={`tab-panel ${i === 0 ? '' : 'hidden'}`}>
          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3">
            {cards.slice(0, 30).map((card: any) => (
              <a href={card.slug ? `/rudc-rec/cards/${card.slug}` : '#'} class="card-hover rounded-lg overflow-hidden bg-gray-900 block hover:ring-2 hover:ring-amber-500 transition" data-card-preview={card.image_uri}>
                {card.image_uri && <img src={card.image_uri} alt={card.name} class="w-full" loading="lazy" onerror="this.style.display='none'" />}
                <div class="p-2">
                  <div class="text-xs font-medium truncate">{card.name}</div>
                  <div class="flex justify-between text-xs text-gray-400 mt-1">
                    <span>{card.inclusion_pct}%</span>
                    <span class="text-green-400">+{card.synergy}%</span>
                  </div>
                </div>
              </a>
            ))}
          </div>
        </div>
      );
    })}
  </div>

  <!-- Decklists -->
  {decks && decks.length > 0 && (
    <div>
      <h2 class="text-2xl font-bold text-amber-400 mb-4">Деклисты ({decks.length})</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="text-gray-400 border-b border-gray-800">
            <tr><th class="text-left py-2 px-2">Дек</th><th class="text-left py-2 px-2">Автор</th><th class="text-left py-2 px-2">Дата</th><th class="text-left py-2 px-2">Ссылка</th></tr>
          </thead>
          <tbody>
            {decks.map((d: any) => (
              <tr class="border-b border-gray-800/50 hover:bg-gray-900">
                <td class="py-2 px-2">{d.name || 'Без названия'}</td>
                <td class="py-2 px-2 text-gray-400">{d.author || '—'}</td>
                <td class="py-2 px-2 text-gray-400">{d.created_at ? new Date(d.created_at).toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '—'}</td>
                <td class="py-2 px-2">{d.url && <a href={d.url} target="_blank" class="text-amber-400 hover:text-amber-300">Moxfield ↗</a>}</td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  )}

  <script>
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const key = (btn as HTMLElement).dataset.tab!;
        document.querySelectorAll('.tab-btn').forEach(b => b.className = 'tab-btn px-4 py-2 rounded-t text-sm font-medium transition bg-gray-800 text-gray-400 hover:text-white');
        btn.className = 'tab-btn px-4 py-2 rounded-t text-sm font-medium transition bg-amber-600 text-white';
        document.querySelectorAll('.tab-panel').forEach(p => (p as HTMLElement).classList.add('hidden'));
        document.querySelector(`[data-panel="${key}"]`)?.classList.remove('hidden');
      });
    });
  </script>
</Layout>
